#cloud-config
hostname: coreos1.example.com
coreos:
  etcd: 
  # Generate a new token for the cluster from https://discovery.etcd.io/new
  discovery: https://discovery.etcd.io/e7c81ac07cd136709e462cfd8a7e0995 
  units:
    - name: etcd2.service
      command: start
    - name: sshd.service
      command: start
    - name: fleet.service
      command: start
    - name: docker.service
      command: start
    - name: iptables-restore.service
      enable: true
      command: start

write_files:
  - path: /home/josepy/.toolboxrc
    owner: josepy
    content: |
      TOOLBOX_DOCKER_IMAGE=centos
      TOOLBOX_DOCKER_TAG=latest
      TOOLBOX_USER=root

  - path: /var/lib/iptables/rules-save
    permissions: 0644
    owner: root:root
    content: |
      *filter
      :INPUT DROP [0:0]
      :FORWARD DROP [0:0]
      :OUTPUT ACCEPT [0:0]
      -A INPUT -i lo -j ACCEPT
      -A INPUT -i eth1 -j ACCEPT
      -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 6999 -m state --state NEW,ESTABLISHED -j ACCEPT
      -A OUTPUT -p tcp --sport 6999 -m state --state ESTABLISHED -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
      -A INPUT -p tcp -m tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
      -A OUTPUT -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT
      -A OUTPUT -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT
      # Accept pings
      -A INPUT -p icmp -m icmp --icmp-type 0 -j ACCEPT
      -A INPUT -p icmp -m icmp --icmp-type 3 -j ACCEPT
      -A INPUT -p icmp -m icmp --icmp-type 11 -j ACCEPT
      COMMIT
  
  - path: /etc/ssh/sshd_config
    content: |
         Port 6999
         Protocol 2
         HostKey /etc/ssh/ssh_host_rsa_key
         HostKey /etc/ssh/ssh_host_dsa_key
         HostKey /etc/ssh/ssh_host_ecdsa_key
         HostKey /etc/ssh/ssh_host_ed25519_key
         UsePrivilegeSeparation yes
         KeyRegenerationInterval 3600
         ServerKeyBits 1024
         SyslogFacility AUTH
         LogLevel INFO
         LoginGraceTime 120
         PermitRootLogin no
         StrictModes yes
         RSAAuthentication yes
         PubkeyAuthentication yes
         IgnoreRhosts yes
         RhostsRSAAuthentication no
         HostbasedAuthentication no
         PermitEmptyPasswords no
         ChallengeResponseAuthentication no
         X11Forwarding yes
         X11DisplayOffset 10
         PrintMotd no
         PrintLastLog yes
         TCPKeepAlive yes
         AcceptEnv LANG LC_*
         Subsystem sftp /usr/lib/openssh/sftp-server
         UsePAM yes
         AllowUsers josepy
users:
  - name: josepy
    gecos: Mutai Josphat
    passwd: $6$T6ekUQ.yJ4AkneW4$MYtZdNHL8ugl77ETxlOa3.lvm1eqjvk04h7dTQ5H46PozHCy2q9E7QpuN/A8g1Ht6eOIwO1cP2RauyennfdxG.
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDPkpo98jFG591oge6RaRAnlFkhG/jo1oGj5n945vREvZUh+pfTzisL404Q2uE8P/WdmEv+ecCMt21EY82/0a/W5bawwGvkoqWnTiWpUkgKvpjCZJBHxG0lME+FngtLuWd/31v3baX7rImdQMRXD0onKj4Tvf6070GziY+GPNHKhV40//tVk0KAfYuMmPlrk26ARIikbPcUMG2Sv3D57FaiA0hzoJsKIQoxfq0ix/WVcFJEYFNXoQ1ks7Js+L2lDR39WKf88V0+I9pjE5QJsWDgjkJ9jmKr93hrGD2jZM1QIgH6ZpS3iLGbpfpCM5LPJNzsLl9U+IqzexTq2Uyw9zvz josepy@arch
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    groups: 
      - docker
      - wheel
      - rkt
      - systemd-journal
      - portage
    shell: /bin/bash

